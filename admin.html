<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>寮管理システム - 管理者画面</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;600;700;900&display=swap" rel="stylesheet">
    <style>
        * { 
            font-family: 'Noto Sans JP', sans-serif;
            scroll-behavior: smooth;
        }
        
        body {
            background: linear-gradient(135deg, #0f0c29 0%, #24243e 50%, #313862 100%);
            min-height: 100vh;
        }
        
        .admin-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 25%, #f093fb 50%, #f5576c 75%, #4facfe 100%);
            background-size: 400% 400%;
            animation: gradientShift 20s ease infinite;
            position: relative;
            overflow: hidden;
        }
        
        .admin-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(1px);
        }
        
        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 24px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .dark-glass-card {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        
        .region-tab {
            padding: 16px 24px;
            border-radius: 16px;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.2);
            color: white;
            font-weight: 600;
            position: relative;
            overflow: hidden;
        }
        
        .region-tab::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.6s;
        }
        
        .region-tab:hover::before {
            left: 100%;
        }
        
        .region-tab:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
        }
        
        .region-tab.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-color: #667eea;
            box-shadow: 0 8px 24px rgba(102, 126, 234, 0.4);
            transform: translateY(-2px);
        }
        
        .metric-card {
            background: white;
            border-radius: 20px;
            padding: 2rem;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(0, 0, 0, 0.05);
        }
        
        .metric-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 6px;
            background: var(--accent-color);
        }
        
        .metric-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
        }
        
        .metric-card.total { --accent-color: linear-gradient(135deg, #667eea, #764ba2); }
        .metric-card.occupancy { --accent-color: linear-gradient(135deg, #3b82f6, #2563eb); }
        .metric-card.revenue { --accent-color: linear-gradient(135deg, #10b981, #059669); }
        .metric-card.attention { --accent-color: linear-gradient(135deg, #ef4444, #dc2626); }
        
        .region-overview {
            background: white;
            border-radius: 20px;
            padding: 1.5rem;
            border-left: 6px solid;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .region-overview::after {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 4px;
            height: 100%;
            background: var(--region-color);
            opacity: 0.3;
        }
        
        .region-overview:hover {
            transform: translateX(4px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
        }
        
        .region-tokyo { 
            border-left-color: #3b82f6; 
            --region-color: #3b82f6;
        }
        .region-yokohama { 
            border-left-color: #06b6d4; 
            --region-color: #06b6d4;
        }
        .region-nagoya { 
            border-left-color: #10b981; 
            --region-color: #10b981;
        }
        .region-yokkaichi { 
            border-left-color: #8b5cf6; 
            --region-color: #8b5cf6;
        }
        .region-fukuoka { 
            border-left-color: #f59e0b; 
            --region-color: #f59e0b;
        }
        
        .nav-button {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 12px 20px;
            border-radius: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .nav-button:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
        }
        
        .nav-button.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-color: #667eea;
        }
        
        .spreadsheet-container {
            background: white;
            border-radius: 24px;
            overflow: hidden;
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(0, 0, 0, 0.05);
        }
        
        .spreadsheet-toolbar {
            background: linear-gradient(135deg, #f8fafc, #e2e8f0);
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            padding: 1.5rem;
        }
        
        .spreadsheet-cell {
            padding: 16px;
            border-right: 1px solid #e5e7eb;
            border-bottom: 1px solid #e5e7eb;
            transition: all 0.2s ease;
            min-width: 150px;
        }
        
        .spreadsheet-cell:hover {
            background-color: #fafbfc;
        }
        
        .spreadsheet-cell input, 
        .spreadsheet-cell select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 14px;
            transition: all 0.3s ease;
            background: white;
        }
        
        .spreadsheet-cell input:focus, 
        .spreadsheet-cell select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
            transform: scale(1.02);
        }
        
        .spreadsheet-header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            font-weight: 700;
            position: sticky;
            top: 0;
            z-index: 10;
            text-align: center;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        
        .btn-primary::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.6s;
        }
        
        .btn-primary:hover::before {
            left: 100%;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }
        
        .btn-secondary {
            background: white;
            color: #374151;
            border: 2px solid #e5e7eb;
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .btn-secondary:hover {
            border-color: #667eea;
            background: #f8fafc;
            transform: translateY(-2px);
        }
        
        .floating-actions {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            z-index: 100;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        
        .floating-btn {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            cursor: pointer;
            font-size: 20px;
            transition: all 0.3s ease;
            box-shadow: 0 8px 24px rgba(102, 126, 234, 0.4);
        }
        
        .floating-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 12px 32px rgba(102, 126, 234, 0.6);
        }
        
        .notification {
            position: fixed;
            top: 2rem;
            right: 2rem;
            background: white;
            border-radius: 16px;
            padding: 1rem 1.5rem;
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
            border-left: 6px solid;
            z-index: 1000;
            animation: slideInRight 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            max-width: 400px;
        }
        
        .notification.success { border-left-color: #10b981; }
        .notification.error { border-left-color: #ef4444; }
        .notification.warning { border-left-color: #f59e0b; }
        .notification.info { border-left-color: #3b82f6; }
        
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(8px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }
        
        .modal-content {
            background: white;
            border-radius: 24px;
            padding: 2rem;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: scaleIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes scaleIn {
            from { transform: scale(0.9); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        
        .table-container {
            max-height: 70vh;
            overflow: auto;
        }
        
        .sticky-column {
            position: sticky;
            left: 0;
            background: white;
            z-index: 5;
            box-shadow: 2px 0 8px rgba(0, 0, 0, 0.05);
        }
        
        .chart-container {
            position: relative;
            height: 320px;
            margin: 1rem 0;
        }
        
        .overview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        @media (max-width: 768px) {
            .overview-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .floating-actions {
                bottom: 1rem;
                right: 1rem;
            }
            
            .floating-btn {
                width: 56px;
                height: 56px;
                font-size: 18px;
            }
            
            .spreadsheet-toolbar {
                flex-direction: column;
                align-items: stretch;
            }
            
            .region-tab {
                padding: 12px 16px;
                margin: 4px;
            }
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 6px solid #f3f4f6;
            border-top: 6px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .activity-item {
            background: white;
            border-radius: 16px;
            padding: 1rem;
            border-left: 4px solid #667eea;
            transition: all 0.3s ease;
            margin-bottom: 0.5rem;
        }
        
        .activity-item:hover {
            transform: translateX(4px);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        
        .status-indicator.vacant { background: #10b981; }
        .status-indicator.occupied { background: #3b82f6; }
        .status-indicator.cleaning { background: #f59e0b; }
        .status-indicator.maintenance { background: #ef4444; }
    </style>
</head>

<body class="min-h-screen">
    <!-- ヘッダー -->
    <header class="admin-header text-white shadow-2xl relative">
        <div class="container mx-auto px-6 py-8 relative z-10">
            <div class="flex flex-col lg:flex-row justify-between items-center">
                <div class="text-center lg:text-left mb-6 lg:mb-0">
                    <h1 class="text-4xl font-black mb-3 drop-shadow-lg">
                        👑 寮管理システム - 管理者画面
                    </h1>
                    <p class="text-xl text-white/90 drop-shadow">全地域統合管理 | 川満さん専用ダッシュボード</p>
                </div>
                
                <div class="flex flex-wrap items-center gap-3">
                    <button onclick="showSection('overview')" class="nav-button">
                        <i class="fas fa-chart-pie mr-2"></i>概要
                    </button>
                    <button onclick="showSection('spreadsheet')" class="nav-button">
                        <i class="fas fa-table mr-2"></i>スプレッドシート
                    </button>
                    <button onclick="showSection('analytics')" class="nav-button">
                        <i class="fas fa-chart-bar mr-2"></i>分析
                    </button>
                    <button onclick="showSection('logs')" class="nav-button">
                        <i class="fas fa-history mr-2"></i>ログ
                    </button>
                    <a href="index.html" class="btn-primary inline-flex items-center">
                        <i class="fas fa-arrow-left mr-2"></i>スタッフ画面
                    </a>
                </div>
            </div>
            
            <!-- 地域タブ -->
            <div class="flex flex-wrap gap-3 mt-8" id="regionTabs">
                <div class="region-tab active" onclick="selectRegion('all')">
                    <i class="fas fa-globe mr-2"></i>全地域
                </div>
                <div class="region-tab" onclick="selectRegion('tokyo')">
                    🗼 東京
                </div>
                <div class="region-tab" onclick="selectRegion('yokohama')">
                    ⚓ 横浜
                </div>
                <div class="region-tab" onclick="selectRegion('nagoya')">
                    🏭 名古屋
                </div>
                <div class="region-tab" onclick="selectRegion('yokkaichi')">
                    🏭 四日市
                </div>
                <div class="region-tab" onclick="selectRegion('fukuoka')">
                    🌸 福岡
                </div>
            </div>
        </div>
    </header>

    <!-- メインコンテンツ -->
    <div class="container mx-auto px-6 py-8">
        <!-- 概要セクション -->
        <div id="overview" class="section">
            <!-- 全体統計 -->
            <div class="stats-grid">
                <div class="metric-card total">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-semibold text-gray-600 uppercase tracking-wide">総室数</p>
                            <p class="text-4xl font-black text-gray-900 mt-2" id="totalRooms">0</p>
                            <p class="text-sm text-gray-500 mt-1">全地域合計</p>
                        </div>
                        <div class="text-purple-600 text-5xl">
                            🏢
                        </div>
                    </div>
                </div>
                
                <div class="metric-card occupancy">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-semibold text-gray-600 uppercase tracking-wide">稼働率</p>
                            <p class="text-4xl font-black text-blue-600 mt-2" id="occupancyRate">0%</p>
                            <p class="text-sm text-gray-500 mt-1">入室中の割合</p>
                        </div>
                        <div class="text-blue-600 text-5xl">
                            📈
                        </div>
                    </div>
                </div>
                
                <div class="metric-card revenue">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-semibold text-gray-600 uppercase tracking-wide">月次売上予想</p>
                            <p class="text-4xl font-black text-green-600 mt-2" id="monthlyRevenue">¥0</p>
                            <p class="text-sm text-gray-500 mt-1">入室中から計算</p>
                        </div>
                        <div class="text-green-600 text-5xl">
                            💰
                        </div>
                    </div>
                </div>
                
                <div class="metric-card attention">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-semibold text-gray-600 uppercase tracking-wide">要対応</p>
                            <p class="text-4xl font-black text-red-600 mt-2" id="attentionNeeded">0</p>
                            <p class="text-sm text-gray-500 mt-1">清掃・メンテナンス</p>
                        </div>
                        <div class="text-red-600 text-5xl">
                            ⚠️
                        </div>
                    </div>
                </div>
            </div>

            <!-- 地域別概要 -->
            <div class="glass-card p-8 mb-8">
                <h3 class="text-2xl font-bold text-gray-800 mb-6">
                    <i class="fas fa-map-marked-alt mr-3 text-purple-600"></i>地域別パフォーマンス
                </h3>
                <div class="overview-grid" id="regionOverviews">
                    <!-- 動的に生成 -->
                </div>
            </div>

            <!-- 今日のアクティビティ -->
            <div class="glass-card p-8">
                <h3 class="text-2xl font-bold text-gray-800 mb-6">
                    <i class="fas fa-clock mr-3 text-blue-600"></i>今日のアクティビティ
                </h3>
                <div id="todayActivities" class="space-y-3">
                    <!-- 動的に生成 -->
                </div>
            </div>
        </div>

        <!-- スプレッドシートセクション -->
        <div id="spreadsheet" class="section hidden">
            <div class="spreadsheet-container">
                <!-- ツールバー -->
                <div class="spreadsheet-toolbar">
                    <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center gap-4">
                        <div class="flex items-center gap-4">
                            <h3 class="text-xl font-bold text-gray-800">
                                <i class="fas fa-table mr-2 text-purple-600"></i>データ管理スプレッドシート
                            </h3>
                            <select id="regionFilter" onchange="filterSpreadsheet()" class="px-4 py-2 border-2 border-gray-200 rounded-lg text-sm font-medium focus:border-purple-500 focus:ring-2 focus:ring-purple-200">
                                <option value="all">全地域</option>
                                <option value="tokyo">🗼 東京</option>
                                <option value="yokohama">⚓ 横浜</option>
                                <option value="nagoya">🏭 名古屋</option>
                                <option value="yokkaichi">🏭 四日市</option>
                                <option value="fukuoka">🌸 福岡</option>
                            </select>
                        </div>
                        
                        <div class="flex flex-wrap gap-3">
                            <button onclick="validateAllData()" class="btn-secondary inline-flex items-center">
                                <i class="fas fa-check-circle mr-2"></i>データ検証
                            </button>
                            <button onclick="bulkEditMode()" class="btn-secondary inline-flex items-center">
                                <i class="fas fa-edit mr-2"></i>一括編集
                            </button>
                            <button onclick="exportToExcel('current')" class="btn-primary inline-flex items-center">
                                <i class="fas fa-file-excel mr-2"></i>Excel出力
                            </button>
                            <button onclick="saveAllChanges()" class="btn-primary inline-flex items-center">
                                <i class="fas fa-save mr-2"></i>保存
                            </button>
                        </div>
                    </div>
                </div>

                <!-- スプレッドシート -->
                <div class="table-container">
                    <table class="w-full text-sm">
                        <thead>
                            <tr class="spreadsheet-header">
                                <th class="sticky-column spreadsheet-cell">地域</th>
                                <th class="sticky-column spreadsheet-cell">寮番号</th>
                                <th class="spreadsheet-cell">ステータス</th>
                                <th class="spreadsheet-cell">最終更新</th>
                                <th class="spreadsheet-cell">担当者</th>
                                <th class="spreadsheet-cell">備考</th>
                                <th class="spreadsheet-cell">入室日</th>
                                <th class="spreadsheet-cell">予定退室日</th>
                                <th class="spreadsheet-cell">月額料金</th>
                                <th class="spreadsheet-cell">支払状況</th>
                                <th class="spreadsheet-cell">清掃状況</th>
                                <th class="spreadsheet-cell">操作</th>
                            </tr>
                        </thead>
                        <tbody id="spreadsheetBody">
                            <!-- 動的に生成 -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- 分析セクション -->
        <div id="analytics" class="section hidden">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- 地域別稼働率 -->
                <div class="glass-card p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">
                        <i class="fas fa-chart-pie mr-2 text-purple-600"></i>地域別稼働率
                    </h3>
                    <div class="chart-container">
                        <canvas id="occupancyChart"></canvas>
                    </div>
                </div>

                <!-- 月次推移 -->
                <div class="glass-card p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">
                        <i class="fas fa-chart-line mr-2 text-blue-600"></i>稼働率推移
                    </h3>
                    <div class="chart-container">
                        <canvas id="trendChart"></canvas>
                    </div>
                </div>

                <!-- ステータス分布 -->
                <div class="glass-card p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">
                        <i class="fas fa-chart-bar mr-2 text-green-600"></i>ステータス分布
                    </h3>
                    <div class="chart-container">
                        <canvas id="statusChart"></canvas>
                    </div>
                </div>

                <!-- 売上分析 -->
                <div class="glass-card p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">
                        <i class="fas fa-money-bill-wave mr-2 text-yellow-600"></i>地域別売上分析
                    </h3>
                    <div class="chart-container">
                        <canvas id="revenueChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- ログセクション -->
        <div id="logs" class="section hidden">
            <div class="glass-card">
                <!-- ログツールバー -->
                <div class="spreadsheet-toolbar">
                    <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center gap-4">
                        <h3 class="text-xl font-bold text-gray-800">
                            <i class="fas fa-history mr-2 text-green-600"></i>活動ログ履歴
                        </h3>
                        <div class="flex items-center gap-3">
                            <select id="logRegionFilter" onchange="filterLogs()" class="px-4 py-2 border-2 border-gray-200 rounded-lg text-sm font-medium">
                                <option value="all">全地域</option>
                                <option value="tokyo">🗼 東京</option>
                                <option value="yokohama">⚓ 横浜</option>
                                <option value="nagoya">🏭 名古屋</option>
                                <option value="yokkaichi">🏭 四日市</option>
                                <option value="fukuoka">🌸 福岡</option>
                            </select>
                            <select id="logPeriodFilter" onchange="filterLogs()" class="px-4 py-2 border-2 border-gray-200 rounded-lg text-sm font-medium">
                                <option value="all">全期間</option>
                                <option value="today">今日</option>
                                <option value="week">今週</option>
                                <option value="month">今月</option>
                            </select>
                            <button onclick="exportToExcel('logs')" class="btn-primary inline-flex items-center">
                                <i class="fas fa-file-excel mr-2"></i>ログ出力
                            </button>
                        </div>
                    </div>
                </div>

                <!-- ログテーブル -->
                <div class="table-container">
                    <table class="w-full text-sm">
                        <thead class="spreadsheet-header">
                            <tr>
                                <th class="spreadsheet-cell">日時</th>
                                <th class="spreadsheet-cell">地域</th>
                                <th class="spreadsheet-cell">寮番号</th>
                                <th class="spreadsheet-cell">操作</th>
                                <th class="spreadsheet-cell">担当者</th>
                                <th class="spreadsheet-cell">備考</th>
                            </tr>
                        </thead>
                        <tbody id="logsTableBody">
                            <!-- 動的に生成 -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- 一括編集モーダル -->
    <div id="bulkEditModal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 class="text-2xl font-bold mb-6 text-gray-800">
                <i class="fas fa-edit mr-3 text-purple-600"></i>一括編集
            </h3>
            
            <div class="space-y-6">
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-3">対象地域</label>
                    <select id="bulkRegion" class="w-full p-3 border-2 border-gray-200 rounded-lg focus:border-purple-500 focus:ring-2 focus:ring-purple-200">
                        <option value="">地域を選択</option>
                        <option value="tokyo">🗼 東京</option>
                        <option value="yokohama">⚓ 横浜</option>
                        <option value="nagoya">🏭 名古屋</option>
                        <option value="yokkaichi">🏭 四日市</option>
                        <option value="fukuoka">🌸 福岡</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-3">対象寮</label>
                    <div class="grid grid-cols-4 gap-3 max-h-40 overflow-y-auto border-2 border-gray-200 rounded-lg p-4" id="bulkSelectDorms">
                        <!-- 動的に生成 -->
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-3">変更するステータス</label>
                    <select id="bulkStatus" class="w-full p-3 border-2 border-gray-200 rounded-lg focus:border-purple-500 focus:ring-2 focus:ring-purple-200">
                        <option value="">選択してください</option>
                        <option value="vacant">🚪 空室</option>
                        <option value="occupied">🏠 入室中</option>
                        <option value="cleaning">🧹 清掃中</option>
                        <option value="maintenance">🔧 メンテナンス</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-3">担当者</label>
                    <input type="text" id="bulkStaff" class="w-full p-3 border-2 border-gray-200 rounded-lg focus:border-purple-500 focus:ring-2 focus:ring-purple-200" placeholder="担当者名">
                </div>
                
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-3">備考</label>
                    <textarea id="bulkNotes" class="w-full p-3 border-2 border-gray-200 rounded-lg focus:border-purple-500 focus:ring-2 focus:ring-purple-200" rows="3" placeholder="一括変更の理由や備考"></textarea>
                </div>
            </div>
            
            <div class="flex justify-end gap-4 mt-8">
                <button onclick="closeBulkEditModal()" class="btn-secondary">
                    キャンセル
                </button>
                <button onclick="executeBulkEdit()" class="btn-primary">
                    一括変更実行
                </button>
            </div>
        </div>
    </div>

    <!-- フローティングアクション -->
    <div class="floating-actions">
        <button class="floating-btn" onclick="quickExport()" title="クイック出力">
            <i class="fas fa-download"></i>
        </button>
        <button class="floating-btn" onclick="showSection('overview')" title="概要に戻る">
            <i class="fas fa-home"></i>
        </button>
    </div>

    <!-- ローディングオーバーレイ -->
    <div id="loadingOverlay" class="loading-overlay hidden">
        <div class="text-center">
            <div class="loading-spinner"></div>
            <p class="mt-4 text-gray-600 font-semibold text-lg">データを処理中...</p>
        </div>
    </div>

    <script>
        // グローバル変数
        let currentRegionFilter = 'all';
        let allDormitories = {};
        let allLogs = [];
        let charts = {};

        // 地域データ（5地域に修正）
        const regions = {
            tokyo: { name: '東京エリア', icon: '🗼', rooms: 20, price: 68000, color: '#3b82f6' },
            yokohama: { name: '横浜エリア', icon: '⚓', rooms: 18, price: 62000, color: '#06b6d4' },
            nagoya: { name: '名古屋エリア', icon: '🏭', rooms: 16, price: 55000, color: '#10b981' },
            yokkaichi: { name: '四日市エリア', icon: '🏭', rooms: 14, price: 48000, color: '#8b5cf6' },
            fukuoka: { name: '福岡エリア', icon: '🌸', rooms: 15, price: 52000, color: '#f59e0b' }
        };

        // データ読み込み
        function loadAllData() {
            showLoading();
            allDormitories = {};
            allLogs = [];

            Object.keys(regions).forEach(regionId => {
                const storageKey = `dormitories_${regionId}`;
                const logsKey = `activityLogs_${regionId}`;
                
                const savedDormitories = localStorage.getItem(storageKey);
                const savedLogs = localStorage.getItem(logsKey);
                
                if (savedDormitories) {
                    const regionDorms = JSON.parse(savedDormitories);
                    Object.keys(regionDorms).forEach(key => {
                        const dorm = regionDorms[key];
                        dorm.region = regionId;
                        dorm.price = regions[regionId].price;
                        if (!dorm.paymentStatus) dorm.paymentStatus = 'paid';
                        if (!dorm.cleaningStatus) dorm.cleaningStatus = 'clean';
                        if (!dorm.checkinDate) dorm.checkinDate = '';
                        if (!dorm.expectedCheckout) dorm.expectedCheckout = '';
                        
                        allDormitories[`${regionId}_${key}`] = dorm;
                    });
                } else {
                    initializeRegionData(regionId);
                }
                
                if (savedLogs) {
                    const regionLogs = JSON.parse(savedLogs);
                    regionLogs.forEach(log => {
                        log.region = regionId;
                        allLogs.push(log);
                    });
                }
            });
            
            allLogs.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            hideLoading();
        }

        function initializeRegionData(regionId) {
            const roomCount = regions[regionId].rooms;
            
            for (let i = 1; i <= roomCount; i++) {
                const dorm = {
                    number: i,
                    region: regionId,
                    status: getRandomStatus(),
                    lastUpdated: new Date().toISOString(),
                    staff: '',
                    notes: '',
                    price: regions[regionId].price,
                    paymentStatus: Math.random() > 0.1 ? 'paid' : 'pending',
                    cleaningStatus: Math.random() > 0.2 ? 'clean' : 'dirty',
                    checkinDate: '',
                    expectedCheckout: ''
                };
                
                if (dorm.status === 'occupied') {
                    dorm.checkinDate = new Date(Date.now() - Math.random() * 60 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
                    dorm.expectedCheckout = new Date(Date.now() + Math.random() * 90 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
                }
                
                allDormitories[`${regionId}_${i}`] = dorm;
            }
            
            saveRegionData(regionId);
        }

        function getRandomStatus() {
            const statuses = ['vacant', 'occupied', 'cleaning', 'maintenance'];
            const weights = [0.3, 0.5, 0.15, 0.05];
            
            const random = Math.random();
            let cumulative = 0;
            
            for (let i = 0; i < statuses.length; i++) {
                cumulative += weights[i];
                if (random < cumulative) {
                    return statuses[i];
                }
            }
            return 'vacant';
        }

        function saveRegionData(regionId) {
            const regionDorms = {};
            const regionLogs = [];
            
            Object.keys(allDormitories).forEach(key => {
                const dorm = allDormitories[key];
                if (dorm.region === regionId) {
                    regionDorms[dorm.number] = dorm;
                }
            });
            
            allLogs.forEach(log => {
                if (log.region === regionId) {
                    regionLogs.push(log);
                }
            });
            
            localStorage.setItem(`dormitories_${regionId}`, JSON.stringify(regionDorms));
            localStorage.setItem(`activityLogs_${regionId}`, JSON.stringify(regionLogs));
        }

        // ローディング表示
        function showLoading() {
            document.getElementById('loadingOverlay').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.add('hidden');
        }

        // セクション切り替え
        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(section => {
                section.classList.add('hidden');
            });
            document.getElementById(sectionId).classList.remove('hidden');

            // ナビゲーション更新
            document.querySelectorAll('.nav-button').forEach(btn => {
                btn.classList.remove('active');
            });
            event?.target.classList.add('active');

            if (sectionId === 'overview') {
                updateOverview();
            } else if (sectionId === 'spreadsheet') {
                renderSpreadsheet();
            } else if (sectionId === 'analytics') {
                renderCharts();
            } else if (sectionId === 'logs') {
                renderLogs();
            }
        }

        // 地域フィルター
        function selectRegion(regionId) {
            currentRegionFilter = regionId;
            
            document.querySelectorAll('.region-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            const currentSection = document.querySelector('.section:not(.hidden)').id;
            showSection(currentSection);
        }

        // 概要更新
        function updateOverview() {
            const filteredDorms = getFilteredDormitories();
            const stats = calculateStatistics(filteredDorms);
            
            document.getElementById('totalRooms').textContent = filteredDorms.length;
            document.getElementById('occupancyRate').textContent = `${Math.round((stats.occupied / filteredDorms.length) * 100)}%`;
            document.getElementById('monthlyRevenue').textContent = `¥${(stats.occupied * getAveragePrice()).toLocaleString()}`;
            document.getElementById('attentionNeeded').textContent = stats.cleaning + stats.maintenance;
            
            renderRegionOverviews();
            renderTodayActivities();
        }

        function getFilteredDormitories() {
            if (currentRegionFilter === 'all') {
                return Object.values(allDormitories);
            }
            return Object.values(allDormitories).filter(dorm => dorm.region === currentRegionFilter);
        }

        function calculateStatistics(dormitories) {
            const stats = { vacant: 0, occupied: 0, cleaning: 0, maintenance: 0 };
            dormitories.forEach(dorm => {
                stats[dorm.status]++;
            });
            return stats;
        }

        function getAveragePrice() {
            const prices = Object.values(regions).map(r => r.price);
            return prices.reduce((sum, price) => sum + price, 0) / prices.length;
        }

        function renderRegionOverviews() {
            const container = document.getElementById('regionOverviews');
            container.innerHTML = '';

            Object.keys(regions).forEach(regionId => {
                const regionDorms = Object.values(allDormitories).filter(dorm => dorm.region === regionId);
                const stats = calculateStatistics(regionDorms);
                const occupancyRate = regionDorms.length > 0 ? Math.round((stats.occupied / regionDorms.length) * 100) : 0;
                
                const card = document.createElement('div');
                card.className = `region-overview region-${regionId}`;
                card.innerHTML = `
                    <div class="flex items-center justify-between mb-4">
                        <div>
                            <h4 class="font-bold text-xl text-gray-800">${regions[regionId].icon} ${regions[regionId].name}</h4>
                            <p class="text-sm text-gray-600 mt-1">${regionDorms.length}室 | 稼働率 ${occupancyRate}%</p>
                        </div>
                        <div class="text-right">
                            <div class="text-2xl font-black text-green-600">¥${(stats.occupied * regions[regionId].price).toLocaleString()}</div>
                            <div class="text-xs text-gray-500">月次売上予想</div>
                        </div>
                    </div>
                    <div class="grid grid-cols-4 gap-3 text-center text-sm">
                        <div class="bg-green-50 p-3 rounded-lg border border-green-200">
                            <div class="font-bold text-green-700 text-lg">${stats.vacant}</div>
                            <div class="text-xs text-gray-600">空室</div>
                        </div>
                        <div class="bg-blue-50 p-3 rounded-lg border border-blue-200">
                            <div class="font-bold text-blue-700 text-lg">${stats.occupied}</div>
                            <div class="text-xs text-gray-600">入室</div>
                        </div>
                        <div class="bg-yellow-50 p-3 rounded-lg border border-yellow-200">
                            <div class="font-bold text-yellow-700 text-lg">${stats.cleaning}</div>
                            <div class="text-xs text-gray-600">清掃</div>
                        </div>
                        <div class="bg-red-50 p-3 rounded-lg border border-red-200">
                            <div class="font-bold text-red-700 text-lg">${stats.maintenance}</div>
                            <div class="text-xs text-gray-600">メンテ</div>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function renderTodayActivities() {
            const today = new Date().toDateString();
            const todayLogs = allLogs.filter(log => 
                new Date(log.timestamp).toDateString() === today &&
                (currentRegionFilter === 'all' || log.region === currentRegionFilter)
            );
            
            const container = document.getElementById('todayActivities');
            if (todayLogs.length === 0) {
                container.innerHTML = '<div class="text-center py-12 text-gray-500"><i class="fas fa-calendar-check text-4xl mb-4"></i><p class="text-lg">今日はまだ活動がありません</p></div>';
                return;
            }
            
            container.innerHTML = todayLogs.slice(0, 10).map(log => `
                <div class="activity-item">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-4">
                            <div class="text-3xl">${regions[log.region].icon}</div>
                            <div>
                                <div class="font-semibold text-gray-800">寮${log.dormNumber} (${regions[log.region].name})</div>
                                <div class="text-sm text-gray-600">${getActionText(log.action)} by ${log.staff}</div>
                                ${log.notes ? `<div class="text-xs text-gray-500 mt-1">${log.notes}</div>` : ''}
                            </div>
                        </div>
                        <div class="text-sm text-gray-500 font-mono">
                            ${new Date(log.timestamp).toLocaleTimeString('ja-JP', {hour: '2-digit', minute: '2-digit'})}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // スプレッドシート描画
        function renderSpreadsheet() {
            const tbody = document.getElementById('spreadsheetBody');
            tbody.innerHTML = '';
            
            const filteredDorms = getFilteredDormitories();
            
            filteredDorms.forEach(dorm => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 transition-colors';
                row.innerHTML = `
                    <td class="sticky-column spreadsheet-cell font-semibold">
                        <div class="flex items-center">
                            <span class="text-lg mr-2">${regions[dorm.region].icon}</span>
                            <span>${regions[dorm.region].name}</span>
                        </div>
                    </td>
                    <td class="sticky-column spreadsheet-cell font-bold text-purple-700">寮${dorm.number}</td>
                    <td class="spreadsheet-cell">
                        <select onchange="updateDormField('${dorm.region}_${dorm.number}', 'status', this.value)">
                            <option value="vacant" ${dorm.status === 'vacant' ? 'selected' : ''}>🚪 空室</option>
                            <option value="occupied" ${dorm.status === 'occupied' ? 'selected' : ''}>🏠 入室中</option>
                            <option value="cleaning" ${dorm.status === 'cleaning' ? 'selected' : ''}>🧹 清掃中</option>
                            <option value="maintenance" ${dorm.status === 'maintenance' ? 'selected' : ''}>🔧 メンテナンス</option>
                        </select>
                    </td>
                    <td class="spreadsheet-cell text-gray-600 font-mono text-xs">
                        ${new Date(dorm.lastUpdated).toLocaleString('ja-JP')}
                    </td>
                    <td class="spreadsheet-cell">
                        <input type="text" value="${dorm.staff || ''}" 
                               onchange="updateDormField('${dorm.region}_${dorm.number}', 'staff', this.value)"
                               placeholder="担当者名">
                    </td>
                    <td class="spreadsheet-cell">
                        <input type="text" value="${dorm.notes || ''}" 
                               onchange="updateDormField('${dorm.region}_${dorm.number}', 'notes', this.value)"
                               placeholder="備考">
                    </td>
                    <td class="spreadsheet-cell">
                        <input type="date" value="${dorm.checkinDate || ''}" 
                               onchange="updateDormField('${dorm.region}_${dorm.number}', 'checkinDate', this.value)">
                    </td>
                    <td class="spreadsheet-cell">
                        <input type="date" value="${dorm.expectedCheckout || ''}" 
                               onchange="updateDormField('${dorm.region}_${dorm.number}', 'expectedCheckout', this.value)">
                    </td>
                    <td class="spreadsheet-cell">
                        <input type="number" value="${dorm.price || ''}" 
                               onchange="updateDormField('${dorm.region}_${dorm.number}', 'price', this.value)"
                               class="text-right font-semibold">
                    </td>
                    <td class="spreadsheet-cell">
                        <select onchange="updateDormField('${dorm.region}_${dorm.number}', 'paymentStatus', this.value)">
                            <option value="paid" ${dorm.paymentStatus === 'paid' ? 'selected' : ''}>✅ 支払済</option>
                            <option value="pending" ${dorm.paymentStatus === 'pending' ? 'selected' : ''}>⏳ 未払い</option>
                            <option value="overdue" ${dorm.paymentStatus === 'overdue' ? 'selected' : ''}>⚠️ 遅延</option>
                        </select>
                    </td>
                    <td class="spreadsheet-cell">
                        <select onchange="updateDormField('${dorm.region}_${dorm.number}', 'cleaningStatus', this.value)">
                            <option value="clean" ${dorm.cleaningStatus === 'clean' ? 'selected' : ''}>✨ 清潔</option>
                            <option value="dirty" ${dorm.cleaningStatus === 'dirty' ? 'selected' : ''}>🧹 要清掃</option>
                            <option value="deep" ${dorm.cleaningStatus === 'deep' ? 'selected' : ''}>🔧 大掃除必要</option>
                        </select>
                    </td>
                    <td class="spreadsheet-cell text-center">
                        <button onclick="deleteDormData('${dorm.region}_${dorm.number}')" 
                                class="text-red-600 hover:text-red-800 hover:bg-red-50 p-2 rounded-lg transition-all"
                                title="削除">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // データ更新
        function updateDormField(dormKey, field, value) {
            allDormitories[dormKey][field] = value;
            allDormitories[dormKey].lastUpdated = new Date().toISOString();
            
            const [region, dormNumber] = dormKey.split('_');
            
            // ログ記録
            allLogs.unshift({
                id: allLogs.length + 1,
                dormNumber: parseInt(dormNumber),
                action: 'update',
                field: field,
                newValue: value,
                staff: '管理者',
                timestamp: new Date().toISOString(),
                notes: `${field}を更新`,
                region: region
            });
            
            saveRegionData(region);
            showNotification('データを更新しました', 'success');
        }

        // チャート描画
        function renderCharts() {
            renderOccupancyChart();
            renderTrendChart();
            renderStatusChart();
            renderRevenueChart();
        }

        function renderOccupancyChart() {
            const ctx = document.getElementById('occupancyChart').getContext('2d');
            
            if (charts.occupancy) {
                charts.occupancy.destroy();
            }
            
            const data = Object.keys(regions).map(regionId => {
                const regionDorms = Object.values(allDormitories).filter(dorm => dorm.region === regionId);
                const occupied = regionDorms.filter(dorm => dorm.status === 'occupied').length;
                return regionDorms.length > 0 ? Math.round((occupied / regionDorms.length) * 100) : 0;
            });
            
            charts.occupancy = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.values(regions).map(r => r.name),
                    datasets: [{
                        data: data,
                        backgroundColor: Object.values(regions).map(r => r.color),
                        borderWidth: 0,
                        hoverOffset: 20
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                usePointStyle: true,
                                padding: 20,
                                font: {
                                    size: 12,
                                    weight: '600'
                                }
                            }
                        }
                    }
                }
            });
        }

        function renderTrendChart() {
            const ctx = document.getElementById('trendChart').getContext('2d');
            
            if (charts.trend) {
                charts.trend.destroy();
            }
            
            const months = ['1月', '2月', '3月', '4月', '5月', '6月'];
            const trendData = months.map(() => Math.floor(Math.random() * 30) + 60);
            
            charts.trend = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: months,
                    datasets: [{
                        label: '稼働率 (%)',
                        data: trendData,
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4,
                        fill: true,
                        borderWidth: 3,
                        pointBackgroundColor: '#667eea',
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 2,
                        pointRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }

        function renderStatusChart() {
            const ctx = document.getElementById('statusChart').getContext('2d');
            
            if (charts.status) {
                charts.status.destroy();
            }
            
            const allStats = calculateStatistics(Object.values(allDormitories));
            
            charts.status = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['🚪 空室', '🏠 入室中', '🧹 清掃中', '🔧 メンテナンス'],
                    datasets: [{
                        data: [allStats.vacant, allStats.occupied, allStats.cleaning, allStats.maintenance],
                        backgroundColor: ['#10b981', '#3b82f6', '#f59e0b', '#ef4444'],
                        borderRadius: 8,
                        borderSkipped: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }

        function renderRevenueChart() {
            const ctx = document.getElementById('revenueChart').getContext('2d');
            
            if (charts.revenue) {
                charts.revenue.destroy();
            }
            
            const revenueData = Object.keys(regions).map(regionId => {
                const regionDorms = Object.values(allDormitories).filter(dorm => dorm.region === regionId);
                const occupied = regionDorms.filter(dorm => dorm.status === 'occupied').length;
                return occupied * regions[regionId].price / 10000; // 万円単位
            });
            
            charts.revenue = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.values(regions).map(r => r.name),
                    datasets: [{
                        label: '売上予想 (万円)',
                        data: revenueData,
                        backgroundColor: Object.values(regions).map(r => r.color),
                        borderRadius: 8,
                        borderSkipped: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }

        // ログ表示
        function renderLogs() {
            const regionFilter = document.getElementById('logRegionFilter').value;
            const periodFilter = document.getElementById('logPeriodFilter').value;
            
            let filteredLogs = allLogs;
            
            if (regionFilter !== 'all') {
                filteredLogs = filteredLogs.filter(log => log.region === regionFilter);
            }
            
            if (periodFilter !== 'all') {
                const now = new Date();
                const filterDate = new Date();
                
                switch (periodFilter) {
                    case 'today':
                        filterDate.setHours(0, 0, 0, 0);
                        break;
                    case 'week':
                        filterDate.setDate(filterDate.getDate() - 7);
                        break;
                    case 'month':
                        filterDate.setMonth(filterDate.getMonth() - 1);
                        break;
                }
                
                filteredLogs = filteredLogs.filter(log => new Date(log.timestamp) >= filterDate);
            }
            
            const tbody = document.getElementById('logsTableBody');
            tbody.innerHTML = filteredLogs.slice(0, 100).map(log => `
                <tr class="border-b hover:bg-gray-50 transition-colors">
                    <td class="spreadsheet-cell text-sm font-mono">${new Date(log.timestamp).toLocaleString('ja-JP')}</td>
                    <td class="spreadsheet-cell">
                        <div class="flex items-center">
                            <span class="text-lg mr-2">${regions[log.region].icon}</span>
                            <span class="font-medium">${regions[log.region].name}</span>
                        </div>
                    </td>
                    <td class="spreadsheet-cell font-semibold text-purple-700">寮${log.dormNumber}</td>
                    <td class="spreadsheet-cell">
                        <span class="px-2 py-1 bg-blue-100 text-blue-800 rounded-full text-xs font-semibold">
                            ${getActionText(log.action)}
                        </span>
                    </td>
                    <td class="spreadsheet-cell font-medium">${log.staff}</td>
                    <td class="spreadsheet-cell text-gray-600">${log.notes || '-'}</td>
                </tr>
            `).join('');
        }

        // Excel出力
        function exportToExcel(type) {
            showLoading();
            
            setTimeout(() => {
                let data, filename;
                
                if (type === 'current') {
                    data = getFilteredDormitories().map(dorm => ({
                        '地域': regions[dorm.region].name,
                        '寮番号': `寮${dorm.number}`,
                        'ステータス': getStatusText(dorm.status),
                        '最終更新': new Date(dorm.lastUpdated).toLocaleString('ja-JP'),
                        '担当者': dorm.staff || '',
                        '備考': dorm.notes || '',
                        '入室日': dorm.checkinDate || '',
                        '予定退室日': dorm.expectedCheckout || '',
                        '月額料金': dorm.price || '',
                        '支払状況': getPaymentStatusText(dorm.paymentStatus),
                        '清掃状況': getCleaningStatusText(dorm.cleaningStatus)
                    }));
                    filename = `全地域寮ステータス_${new Date().toISOString().split('T')[0]}.xlsx`;
                } else {
                    data = allLogs.map(log => ({
                        '日時': new Date(log.timestamp).toLocaleString('ja-JP'),
                        '地域': regions[log.region].name,
                        '寮番号': `寮${log.dormNumber}`,
                        '操作': getActionText(log.action),
                        '担当者': log.staff,
                        '備考': log.notes || ''
                    }));
                    filename = `全地域活動ログ_${new Date().toISOString().split('T')[0]}.xlsx`;
                }

                const ws = XLSX.utils.json_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'データ');
                XLSX.writeFile(wb, filename);
                
                hideLoading();
                showNotification('Excelファイルをダウンロードしました', 'success');
            }, 1000);
        }

        // ユーティリティ関数
        function getStatusText(status) {
            const statusMap = {
                vacant: '空室',
                occupied: '入室中',
                cleaning: '清掃中',
                maintenance: 'メンテナンス'
            };
            return statusMap[status] || status;
        }

        function getActionText(action) {
            const actionMap = {
                checkin: '入室',
                checkout: '退室',
                cleaning: '清掃開始',
                cleaned: '清掃完了',
                update: 'データ更新',
                bulk_update: '一括更新'
            };
            return actionMap[action] || action;
        }

        function getPaymentStatusText(status) {
            const statusMap = {
                paid: '支払済',
                pending: '未払い',
                overdue: '遅延'
            };
            return statusMap[status] || status;
        }

        function getCleaningStatusText(status) {
            const statusMap = {
                clean: '清潔',
                dirty: '要清掃',
                deep: '大掃除必要'
            };
            return statusMap[status] || status;
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            
            const iconMap = {
                success: 'fas fa-check-circle text-green-600',
                error: 'fas fa-exclamation-circle text-red-600',
                warning: 'fas fa-exclamation-triangle text-yellow-600',
                info: 'fas fa-info-circle text-blue-600'
            };
            
            notification.innerHTML = `
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <i class="${iconMap[type]} mr-3 text-lg"></i>
                        <span class="font-semibold">${message}</span>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" class="ml-4 text-gray-400 hover:text-gray-600 text-lg">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 5000);
        }

        function saveAllChanges() {
            showLoading();
            setTimeout(() => {
                Object.keys(regions).forEach(regionId => {
                    saveRegionData(regionId);
                });
                hideLoading();
                showNotification('すべての変更を保存しました', 'success');
            }, 500);
        }

        function quickExport() {
            exportToExcel('current');
        }

        function filterSpreadsheet() {
            const regionFilter = document.getElementById('regionFilter').value;
            currentRegionFilter = regionFilter;
            renderSpreadsheet();
        }

        function filterLogs() {
            renderLogs();
        }

        // 一括編集関連
        function bulkEditMode() {
            document.getElementById('bulkEditModal').classList.remove('hidden');
        }

        function closeBulkEditModal() {
            document.getElementById('bulkEditModal').classList.add('hidden');
            document.getElementById('bulkRegion').value = '';
            document.getElementById('bulkStatus').value = '';
            document.getElementById('bulkStaff').value = '';
            document.getElementById('bulkNotes').value = '';
            document.getElementById('bulkSelectDorms').innerHTML = '';
        }

        document.getElementById('bulkRegion').addEventListener('change', function() {
            const regionId = this.value;
            const dormsContainer = document.getElementById('bulkSelectDorms');
            
            if (!regionId) {
                dormsContainer.innerHTML = '';
                return;
            }
            
            const regionDorms = Object.values(allDormitories).filter(dorm => dorm.region === regionId);
            
            dormsContainer.innerHTML = regionDorms.map(dorm => `
                <label class="flex items-center space-x-2 p-2 hover:bg-gray-50 rounded cursor-pointer">
                    <input type="checkbox" value="${regionId}_${dorm.number}" class="bulk-dorm-checkbox">
                    <span class="text-sm font-medium">寮${dorm.number}</span>
                </label>
            `).join('');
        });

        function executeBulkEdit() {
            const selectedDorms = Array.from(document.querySelectorAll('.bulk-dorm-checkbox:checked')).map(cb => cb.value);
            const status = document.getElementById('bulkStatus').value;
            const staff = document.getElementById('bulkStaff').value;
            const notes = document.getElementById('bulkNotes').value;
            
            if (selectedDorms.length === 0) {
                showNotification('寮を選択してください', 'error');
                return;
            }
            
            if (!status && !staff && !notes) {
                showNotification('変更する項目を入力してください', 'error');
                return;
            }
            
            showLoading();
            
            setTimeout(() => {
                selectedDorms.forEach(dormKey => {
                    const dorm = allDormitories[dormKey];
                    const [region, dormNumber] = dormKey.split('_');
                    
                    if (status) dorm.status = status;
                    if (staff) dorm.staff = staff;
                    if (notes) dorm.notes = notes;
                    dorm.lastUpdated = new Date().toISOString();
                    
                    allLogs.unshift({
                        id: allLogs.length + 1,
                        dormNumber: parseInt(dormNumber),
                        action: 'bulk_update',
                        staff: '管理者',
                        timestamp: new Date().toISOString(),
                        notes: `一括編集: ${notes}`,
                        region: region
                    });
                    
                    saveRegionData(region);
                });
                
                hideLoading();
                closeBulkEditModal();
                renderSpreadsheet();
                updateOverview();
                showNotification(`${selectedDorms.length}件の寮を一括更新しました`, 'success');
            }, 1000);
        }

        function deleteDormData(dormKey) {
            if (!confirm('本当にこの寮のデータを削除しますか？')) {
                return;
            }
            
            const [region, dormNumber] = dormKey.split('_');
            
            allLogs.unshift({
                id: allLogs.length + 1,
                dormNumber: parseInt(dormNumber),
                action: 'delete',
                staff: '管理者',
                timestamp: new Date().toISOString(),
                notes: 'データ削除',
                region: region
            });
            
            delete allDormitories[dormKey];
            saveRegionData(region);
            renderSpreadsheet();
            updateOverview();
            showNotification('データを削除しました', 'success');
        }

        function validateAllData() {
            showLoading();
            
            setTimeout(() => {
                const errors = [];
                const warnings = [];
                
                Object.values(allDormitories).forEach(dorm => {
                    const dormId = `${regions[dorm.region].name} 寮${dorm.number}`;
                    
                    if (dorm.status === 'occupied' && !dorm.checkinDate) {
                        errors.push(`${dormId}: 入室中ですが入室日が設定されていません`);
                    }
                    
                    if (dorm.status === 'occupied' && dorm.paymentStatus === 'overdue') {
                        warnings.push(`${dormId}: 入室中ですが支払いが遅延しています`);
                    }
                    
                    if (dorm.expectedCheckout && new Date(dorm.expectedCheckout) < new Date() && dorm.status === 'occupied') {
                        errors.push(`${dormId}: 退室予定日が過ぎています`);
                    }
                    
                    if (dorm.status === 'cleaning' && dorm.cleaningStatus === 'clean') {
                        warnings.push(`${dormId}: 清掃中ですが清掃状況が「清潔」になっています`);
                    }
                    
                    if (!dorm.price || dorm.price <= 0) {
                        errors.push(`${dormId}: 料金が設定されていません`);
                    }
                });
                
                hideLoading();
                
                let message = '';
                if (errors.length === 0 && warnings.length === 0) {
                    message = '✅ データに問題はありません';
                    showNotification(message, 'success');
                } else {
                    message = `⚠️ エラー: ${errors.length}件, 警告: ${warnings.length}件を検出しました。`;
                    showNotification(message, 'warning');
                    
                    if (errors.length > 0) {
                        console.group('🚨 エラー');
                        errors.forEach(error => console.error(error));
                        console.groupEnd();
                    }
                    
                    if (warnings.length > 0) {
                        console.group('⚠️ 警告');
                        warnings.forEach(warning => console.warn(warning));
                        console.groupEnd();
                    }
                    
                    console.log('詳細は上記のコンソールログをご確認ください。');
                }
            }, 1500);
        }

        // 初期化
        document.addEventListener('DOMContentLoaded', function() {
            loadAllData();
            updateOverview();
            showSection('overview');
            console.log('管理者システムが正常に読み込まれました');
        });
    </script>
</body>
</html>